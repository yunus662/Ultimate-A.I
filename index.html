<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>J.A.R.V.I.S. Control Panel</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Inline minimal CSSâ€”move to styles.css as you like */
    :root {
      --bg: #202023;
      --fg: #f0f0f5;
      --accent: #4F8EF7;
      --border: #2b2b30;
      --font: 'Segoe UI', sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      display: grid;
      grid-template-rows: 60px 1fr 60px;
      grid-template-columns: 1fr 300px;
      grid-template-areas:
        "header header"
        "chat monitor"
        "input monitor";
      height: 100vh;
      background: var(--bg);
      color: var(--fg);
      font-family: var(--font);
    }
    header {
      grid-area: header;
      background: var(--accent);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px;
    }
    header h1 { font-size: 1.2rem; margin: 0; }
    header button {
      background: var(--bg); color: var(--accent);
      border: none; padding: 8px 12px; border-radius: 4px;
      cursor: pointer; font-size: 0.9rem;
    }
    #chat { grid-area: chat; overflow-y: auto; padding: 16px; border-right:1px solid var(--border);}
    .msg { margin:8px 0; max-width: 75%; padding:10px; border-radius:6px; line-height:1.4; }
    .msg.user { background:#2b2b30; margin-left:auto; }
    .msg.ai   { background:#333; margin-right:auto; }
    #monitor { grid-area: monitor; border-left:1px solid var(--border); overflow-y:auto; padding:16px; font-size:0.85rem;}
    #input { grid-area: input; display:flex; align-items:center; padding:0 16px; background:#2b2b30; border-top:1px solid var(--border);}
    #chat-in { flex:1; border:1px solid var(--border); border-radius:4px; padding:8px; margin-right:8px; background:#1f1f22; color:var(--fg);}
    #input button { margin-left:4px; background:var(--accent); border:none; color:var(--bg); padding:8px 12px; border-radius:4px; cursor:pointer;}
    #mic { background:transparent;font-size:1.2rem;}
  </style>
</head>
<body>

  <header>
    <h1>Ahmed Control Panel</h1>
    <div>
      <button id="btn-auth">Connect GitHub</button>
      <button id="btn-update">Update AI</button>
    </div>
  </header>

  <div id="chat"></div>
  <div id="monitor"><h2>System Logs</h2><div id="logs"></div></div>

  <div id="input">
    <textarea id="chat-in" rows="1" placeholder="Ask me anythingâ€¦"></textarea>
    <button id="mic">ðŸŽ¤</button>
    <button id="btn-send">Send</button>
    <button id="btn-upload">ðŸ“Ž</button>
    <input type="file" id="file-input" style="display:none" />
  </div>

  <script>
    // --- Elements ---
    const chat = document.getElementById('chat');
    const logs = document.getElementById('logs');
    const input = document.getElementById('chat-in');
    const send = document.getElementById('btn-send');
    const mic  = document.getElementById('mic');
    const upBtn= document.getElementById('btn-upload');
    const file = document.getElementById('file-input');
    const auth = document.getElementById('btn-auth');
    const upd  = document.getElementById('btn-update');

    // --- SSE Logs ---
    const sse = new EventSource('/api/monitor');
    sse.onmessage = e => {
      const p = document.createElement('p');
      p.textContent = e.data;
      logs.appendChild(p);
      logs.scrollTop = logs.scrollHeight;
    };

    // --- Helpers ---
    function addMsg(who, txt){
      const d = document.createElement('div');
      d.className = 'msg ' + who;
      d.textContent = txt;
      chat.appendChild(d);
      chat.scrollTop = chat.scrollHeight;
    }

    async function chatReq(text, extra={}){
      addMsg('user', text);
      const res = await fetch('/api/chat', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({message:text, ...extra})
      });
      const json = await res.json();
      // Unknown task? Trigger self-update
      if(json.upgrade_required){
        addMsg('ai','ðŸ”§ Upgrading AIâ€¦');
        await fetch('/api/self_update',{method:'POST'});
        addMsg('ai','âœ… Upgrade complete. Re-runningâ€¦');
        return chatReq(text, extra);
      }
      addMsg('ai', json.reply);
    }

    send.onclick = ()=> {
      const t = input.value.trim();
      if(!t) return;
      chatReq(t);
      input.value='';
    };
    input.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send.click(); }
    });

    // --- Mic Input ---
    if(window.SpeechRecognition||window.webkitSpeechRecognition){
      const SR = window.SpeechRecognition||window.webkitSpeechRecognition;
      const r = new SR();
      r.continuous = false;
      r.onresult = e=>{
        input.value = e.results[0][0].transcript;
        send.click();
      };
      mic.onclick = ()=> r.start();
    }

    // --- File Upload ---
    upBtn.onclick = ()=> file.click();
    file.onchange = async ()=>{
      const f = file.files[0];
      const fd = new FormData(); fd.append('file', f);
      const res = await fetch('/api/upload',{method:'POST',body:fd});
      const json = await res.json();
      addMsg('user', `ðŸ“Ž ${f.name}`);
      addMsg('ai', json.reply);
      file.value='';
    };

    // --- GitHub & Update ---
    auth.onclick = ()=> window.location.href = '/auth/github';
    upd.onclick  = async ()=>{
      addMsg('ai','ðŸ”§ Manual updateâ€¦');
      await fetch('/api/self_update',{method:'POST'});
      addMsg('ai','âœ… Done');
    };
  </script>

</body>
</html>
